<%= form_for(@print) do |f| %>
  <% if @print.new_record? %>
    <%= content_for :js_extra do -%>
      <%= raw "var print_job='#{generate_template(f, :print_jobs,
        :locals => {:disabled => false})}';" %>
      <%= raw "var article_line='#{generate_template(f, :article_lines,
        :locals => {:disabled => false})}';" %>
    <% end -%>
  <% end %>
  <%= show_error_messages(@print) %>

  <table class="field_container">
    <tbody>
      <tr>
        <td class="label"><%= f.label :printer %></td>
        <td><%= print_destinations_field(f) %></td>
        <td class="label"><%= f.label :customer, :for => :print_auto_customer_name %></td>
        <td>
          <% field_classes = [:autocomplete_field] %>
          <% field_classes << :field_with_errors unless @print.errors[:customer_id].blank? %>
          <%= f.text_field :auto_customer_name, :value => @print.customer,
            :class => field_classes.join(' '),
            :'data-autocomplete-url' => autocomplete_for_customer_name_prints_path %>
          <% if @print.customer %>
            <%= link_to_function 'X', "clearCustomer(); $(this).remove()",
              :class => :remove %>
          <% end %>
          <%= f.hidden_field :customer_id, :class => :autocomplete_id %>
          <%= hidden_field_tag :customer_free_credit,
            @print.customer.try(:free_credit), :id => :customer_free_credit %>
        </td>
      </tr>
      <tr>
        <td class="label"><%= f.label :scheduled_at %></td>
        <td><%= f.text_field :scheduled_at, :class => :calendar, :'data-time' => true %></td>
        <td class="label"><%= f.label :avoid_printing %></td>
        <td><%= f.check_box :avoid_printing %></td>
      </tr>
    </tbody>
  </table>

  <section class="nested_items">
    <table class="header">
      <tbody>
        <tr>
          <td class="title"><h2><%= t :print_jobs, :scope => [:view, :prints] %></h2></td>
          <td class="place_holder">&nbsp;</td>
        </tr>
      </tbody>
    </table>
    
    <div id="print_jobs_headers" class="headers">
      <h3><%= PrintJob.human_attribute_name :document_id %></h3>
      <h3><%= PrintJob.human_attribute_name :copies %></h3>
      <h3><%= PrintJob.human_attribute_name :pages %></h3>
      <h3><%= PrintJob.human_attribute_name :price_per_copy %></h3>
      <h3><%= PrintJob.human_attribute_name :range %></h3>
      <h3><%= PrintJob.human_attribute_name :two_sided %></h3>
      <br class="break" />
    </div>
    
    <div id="print_jobs" class="items">
      <% @print.print_jobs.build if @print.print_jobs.empty? %>
      <%= f.fields_for :print_jobs do |pj_f| %>
        <%= render :partial => 'print_job', :locals => {
          :f => pj_f, :is_dynamic => false, :disabled => !@print.new_record?
        } %>
      <% end %>
    </div>
  </section>

  <div class="add_nested_item">
    <%= link_to_if @print.new_record?, t(:'view.prints.add_print_job'), '#',
      :'data-template' => :print_job, :'data-container' => '#print_jobs',
      :'data-event' => 'addNestedItem', :id => :add_print_job_link,
      :title => t(:'view.prints.add_print_job_title'),
      :class => 'button white' %>
  </div>

  <section class="nested_items">
    <table class="header">
      <tbody>
        <tr>
          <td class="title"><h2><%= t :article_lines, :scope => [:view, :prints] %></h2></td>
          <td class="place_holder">&nbsp;</td>
        </tr>
      </tbody>
    </table>

    <div id="article_lines_headers" class="headers">
      <h3><%= ArticleLine.human_attribute_name :article_id %></h3>
      <h3><%= ArticleLine.human_attribute_name :units %></h3>
      <h3><%= ArticleLine.human_attribute_name :unit_price %></h3>
      <br class="break" />
    </div>

    <div id="article_lines" class="items">
      <% @print.article_lines.build if @print.article_lines.empty? %>
      <%= f.fields_for :article_lines do |pj_f| %>
        <%= render :partial => 'article_line', :locals => {
          :f => pj_f, :is_dynamic => false, :disabled => !@print.new_record?
        } %>
      <% end %>
    </div>
  </section>

  <div class="add_nested_item">
    <%= link_to_if @print.new_record?, t(:'view.prints.add_article_line'), '#',
      :'data-template' => :article_line, :'data-container' => '#article_lines',
      :'data-event' => 'addNestedItem', :id => :add_article_line_link,
      :title => t(:'view.prints.add_article_line_title'),
      :class => 'button white' %>
  </div>

  <section class="nested_items">
    <table class="header">
      <tbody>
        <tr>
          <td class="title"><h2><%= t :payment, :scope => [:view, :prints] %></h2></td>
          <td class="place_holder">&nbsp;</td>
        </tr>
      </tbody>
    </table>
    <table class="summary">
      <thead>
        <tr>
          <th><%= Payment.human_attribute_name :amount %></th>
          <th><%= Payment.human_attribute_name :paid %></th>
          <th><%= Print.human_attribute_name :credit_password %></th>
          <th><%= Payment.human_attribute_name :paid_with %></th>
        </tr>
      </thead>
      <tbody>
        <%= f.fields_for :payments do |p_f| %>
          <tr>
            <td>
              <%= p_f.text_field :amount, :value => '%.3f' % p_f.object.amount,
                :id => "payment_#{p_f.object.paid_with}_amount", :maxlength => 15,
                :readonly => true %>
            </td>
            <td>
              <%= p_f.text_field :paid, :value => '%.3f' % p_f.object.paid,
                :id => "payment_#{p_f.object.paid_with}_paid", :maxlength => 15,
                :readonly => p_f.object.bonus? %>
            </td>
            <td>
              <% if p_f.object.bonus? %>
                <%= f.password_field :credit_password, :value => '', :size => 15, :maxlength => 255 %>
              <% else %>
                &nbsp;
              <% end %>
            </td>
            <td>
              <%= p_f.object.paid_with_text %>
              <%= p_f.hidden_field :paid_with %>
              <%= p_f.hidden_field :lock_version %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </section>

  <div class="actions">
    <%= f.hidden_field :lock_version %>
    <%= f.submit nil, :id => :print_submit, :class => 'button white',
      :title => t(:'view.prints.print_title') %>
  </div>
<% end %>
<script type="text/javascript">
  function updateTotalPrice() {
    var cashPrefix = '#payment_<%= Payment::PAID_WITH[:cash] %>';
    var bonusPrefix = '#payment_<%= Payment::PAID_WITH[:bonus] %>';
    var freeCredit = parseFloat($('#customer_free_credit').val()) || 0.0;
    var payWithCash = 0.0, payWithBonus = 0.0;
    var totalPrice = 0.0;
    
    $('.print_job').each(function() {
      var pjPrice = ($(this).data('exclude_from_total') ?
        0 : (parseFloat($(this).data('price')) || 0));

      totalPrice += pjPrice;
    });

    $('.article_line').each(function() {
      var alPrice = ($(this).data('exclude_from_total') ?
        0 : (parseFloat($(this).data('price')) || 0));

      totalPrice += alPrice;
    });

    if(freeCredit > totalPrice) {
      payWithCash = 0.0;
      payWithBonus = totalPrice;
    } else {
      payWithCash = totalPrice - freeCredit;
      payWithBonus = freeCredit;
    }

    $(cashPrefix + '_amount').val(payWithCash.toFixed(3));
    $(cashPrefix + '_paid').val(payWithCash.toFixed(3));
    $(bonusPrefix + '_amount').val(payWithBonus.toFixed(3));
    $(bonusPrefix + '_paid').val(payWithBonus.toFixed(3));
  }

  function updatePrintJobPrice(printJob) {
    var copies = parseInt($('input[name$="[copies]"]', printJob).val());
    var pricePerCopy = parseFloat(
      $('input[name$="[price_per_copy]"]', printJob).val()
    );
    var pricePerOneSidedCopy = parseFloat(
      $('input[name$="[two_sided]"].price_modifier', printJob).data(
        'price-per-one-sided')
    );
    var rangePages = parseInt(
      $('input[name$="[range]"]', printJob).data('range-pages')
    );
    var evenRange = rangePages - (rangePages % 2);
    var rest = (rangePages % 2) * pricePerOneSidedCopy;
    var jobPrice = (copies * (pricePerCopy * evenRange + rest)) || 0;
    var money = $('span.money', printJob);

    printJob.data('price', jobPrice);
    money.html(money.html().replace(/(\d+.)+\d+/, jobPrice.toFixed(3)));

    updateTotalPrice();
  }

  function updateArticleLinePrice(articleLine) {
    var units = parseInt($('input[name$="[units]"]', articleLine).val());
    var unitPrice = parseFloat(
      $('input[name$="[unit_price]"]', articleLine).val()
    );
    var articlePrice = (units * unitPrice) || 0;
    var money = $('span.money', articleLine);

    articleLine.data('price', articlePrice);
    money.html(money.html().replace(/(\d+.)+\d+/, articlePrice.toFixed(3)));

    updateTotalPrice();
  }
  
  function clearCustomer() {
    $('#print_auto_customer_name').val('');
    $('#print_customer_id').val('');
    $('#customer_free_credit').val('');
    $('#link_to_customer_credit_detail').hide();
    
    updateTotalPrice();
  }

  $('.print_job').live('item:removed', function() {
    $(this).data('exclude_from_total', true);

    updateTotalPrice();
  });

  $('.article_line').live('item:removed', function() {
    $(this).data('exclude_from_total', true);

    updateTotalPrice();
  });

  $('input.autocomplete_field').live('autocomplete:update', function() {
    var item = $(this).data('item');
    
    if (item.pages) {
      var pages = item.pages;
      var printJob = $(this).parents('.print_job');
      var detailsLink = $('a.details_link', printJob);

      $('input[name$="[pages]"]', printJob).val(pages).attr('disabled', true);
      detailsLink.attr(
        'href', detailsLink.attr('href').replace(/\d+$/, item.id)
      ).show();
      $('.dynamic_details', printJob).text('');
      $('input[name$="[range]"]', printJob).val('').data('range-pages', pages);

      updatePrintJobPrice(printJob);
    } else if (item.unit_price) {
      var unitPrice = parseFloat(item.unit_price).toFixed(3);
      var articleLine = $(this).parents('.article_line');

      $('input[name$="[unit_price]"]', articleLine).val(unitPrice);

      updateArticleLinePrice(articleLine);
    } else if (item.free_credit) {
      $('#customer_free_credit').val(item.free_credit);
      var detailsLink = $('#link_to_customer_credit_detail');
      detailsLink.attr(
        'href', detailsLink.attr('href').replace(/\d+/, item.id)
      ).show();

      updateTotalPrice();
    }
  });

  $('input[name$="[range]"]').live('keyup', function() {
    var element = $(this);
    var validRanges = true, maxPage = undefined, rangePages = 0;
    var pages = parseInt(
      $('input[name$="[pages]"]', element.parents('.print_job')).val()
    );
    var ranges = element.val().trim().split(/\s*,\s*/).sort(function(r1, r2) {
      var r1Value = parseInt(r1.match(/^\d+/)) || 0;
      var r2Value = parseInt(r2.match(/^\d+/)) || 0;
      
      return r1Value - r2Value;
    });

    jQuery.each(ranges, function(i, r) {
      var data = r.match(/^(\d+)(-(\d+))?$/);
      var n1 = Try.these(function() { return parseInt(data[1]); });
      var n2 = Try.these(function() { return parseInt(data[3]); });

      validRanges = validRanges && n1 && n1 > 0 && (!n2 || n1 < n2);
      validRanges = validRanges && (!maxPage || maxPage < n1);

      maxPage = n2 || n1;
      rangePages += n2 ? n2 + 1 - n1 : 1
    });

    if((/^\s*$/.test(element.val()) || validRanges) &&
      (!pages || !maxPage || pages >= maxPage)) {
      element.removeClass('field_with_errors');

      if(/^\s*$/.test(element.val()) && pages) {
        element.data('range-pages', pages);
      } else if(!/^\s*$/.test(element.val()) && validRanges) {
        element.data('range-pages', rangePages);
      }
    } else {
      element.addClass('field_with_errors');
    }
  });

  $('#print_printer').change(function() {
    var submit = $('#print_submit');

    if(/^\s*$/.test($(this).val())) {
      if(submit.data('original_value')) {
        submit.attr('value', submit.data('original_value'));
      }
    } else {
      if(!submit.data('original_value')) {
        submit.data('original_value', submit.attr('value'));
      }

      submit.attr('value', '<%= t(:'view.prints.print') %>');
    }
  });
  
  $('input[name="[print_auto_customer_name]"]').live('change', function() {
    if(/^\s*$/.test($(this).val())) { clearCustomer(); }
  });

  $('input[name$="[two_sided]"]').live('change', function() {
    var element = $(this);
    var priceElement = $('input[name$="[price_per_copy]"]',
      element.parents('.print_job'));
    
    if(element.is(':checked')) {
      priceElement.val(element.data('price-per-two-sided'));
    } else {
      priceElement.val(element.data('price-per-one-sided'));
    }
  });

  $('input[name$="[auto_document_name]"]').live('change', function() {
    var element = $(this);
    var printJob = element.parents('.print_job');

    if(printJob.length > 0 && /^\s*$/.test(element.val())) {
      $('input[name$="[range]"]', printJob).data('range-pages', 0);
      $('input[name$="[pages]"]', printJob).val('').attr('disabled', false);
      $('.dynamic_details', printJob).html('');
      $('a.details_link', printJob).hide();

      updatePrintJobPrice(printJob);
    }
  });

  $('input[name$="[auto_article_name]"]').live('change', function() {
    var element = $(this);
    var articleLine = element.parents('.article_line');

    if(articleLine.length > 0 && /^\s*$/.test(element.val())) {
      $('input[name$="[units]"]', articleLine).val('0');
      $('input[name$="[unit_price]"]', articleLine).val('');

      updateArticleLinePrice(articleLine);
    }
  });

  $('input[name$="[pages]"]').live('change', function() {
    var element = $(this);
    var printJob = element.parents('.print_job');

    if(!element.attr('disabled') && parseInt(element.val()) > 0) {
      var range = $('input[name$="[range]"]', printJob);

      range.data('range-pages', parseInt(element.val())).attr('disabled', true);
      $('input[name$="[auto_document_name]"]', printJob).attr('disabled', true);
    } else {
      $('input[name$="[range]"]', printJob).attr('disabled', false);
      $('input[name$="[auto_document_name]"]', printJob).attr('disabled', false);
    }

    updatePrintJobPrice(printJob);
  });

  $('.price_modifier').live('change', function() {
    var element = $(this);
    
    if (element.parents('.print_job')) {
      updatePrintJobPrice(element.parents('.print_job'));
    } else if (element.parents('.article_line')) {
      updateArticleLinePrice(element.parents('.article_line'));
    }
  });
  
  $('a.details_link').live('ajax:success', function(event, data) {
    Helper.show($('.dynamic_details', $(this).parents('.print_job')).hide().html(data));
  });
  
  $('#link_to_customer_credit_detail').live('ajax:success', function(event, data) {
    $('#print_customer_credit_detail').html(data);
  });

  // Captura de atajos de teclado
  $(document).keydown(function(e) {
    var key = e.which;

    // CTRL + ALT + I = Agregar un trabajo
    if((key == 73 || key == 105) && e.ctrlKey && e.altKey) {
      $('#add_print_job_link').click();
      e.preventDefault();
    // CTRL + ALT + A = Agregar un artículo
    } else if((key == 65 || key == 97) && e.ctrlKey && e.altKey) {
      $('#add_article_line_link').click();
      e.preventDefault();
    // CTRL + ALT + P = Imprimir
    } else if((key == 80 || key == 112) && e.ctrlKey && e.altKey) {
      $('#print_submit').click();
      e.preventDefault();
    }
  });
  
  updateTotalPrice();
</script>